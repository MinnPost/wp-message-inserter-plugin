"use strict";

/**
 * Sets cookies
 *
 * @param {string} name
 * @param {string} value
 * @param {number} days
 */
function setCookie(name, value, days) {
  var d = new Date();
  d.setTime(d.getTime() + 86400000 * days);
  document.cookie = name + '=' + value + ';path=/;expires=' + d.toGMTString();
}
/**
 * Reads cookies
 *
 * @param {string} name
 */


function getCookie(name) {
  var value = document.cookie.match('(^|;) ?' + name + '=([^;]*)(;|$)');
  return value ? value[2] : null;
}
/**
 * Allow our theme or other plugins to create analytics tracking events
 *
 * @param {string}  type
 * @param {string}  category
 * @param {string}  action
 * @param {string}  label
 * @param {Array}   value
 * @param {boolean} nonInteraction
 */


function analyticsTrackingEvent(type, category, action, label, value, nonInteraction) {
  if (typeof wp !== 'undefined') {
    category = 'Site Message: ' + category.charAt(0).toUpperCase() + category.slice(1);
    wp.hooks.doAction('wpMessageInserterAnalyticsEvent', type, category, action, label, value, nonInteraction);
  }
}
/**
 * Faux "Session" checking/setting.
 *
 * @return {number} currentCount
 */


function setCurrentCount() {
  // Timestamp stored on the cookie
  var currentCount = getCookie('count');
  var timestamp = Math.floor(new Date().getTime() / 1000);
  var cookieExpiration = 30; // expire the cooke in 30 days

  if (!getCookie('count')) {
    // First Visit - set count to 1
    setCookie('count', 1, cookieExpiration); // Set a timecheck cookie for an hour from now

    setCookie('timecheck', timestamp + 3600, cookieExpiration);
  } else if (timestamp > getCookie('timecheck')) {
    // Update Timecheck to new value
    setCookie('timecheck', timestamp + 3600, cookieExpiration); // Count exists already and it has been an hour. Update count

    setCookie('count', ++currentCount, cookieExpiration);
  }

  var urlParams = new URLSearchParams(window.location.search);

  if (urlParams.get('count') !== null) {
    currentCount = parseInt(urlParams.get('count'));
  }

  return currentCount;
}
/**
 * Get the WordPress post ID for a given popup.
 *
 * @param {Object} message
 * @return {number} postId
 */


function getPostId(message) {
  var postId = 0;
  message.classList.forEach(function (value) {
    if (0 < value.indexOf('message-id')) {
      postId = value.substring(value.lastIndexOf('-') + 1);
      return postId;
    }
  });
  return postId;
}
/**
 * Get the region for a given message.
 *
 * @param {Object} message
 * @return {string} region
 */


function getMessageRegion(message) {
  var region = '';
  message.classList.forEach(function (value) {
    if (0 < value.indexOf('message-region')) {
      region = value.substring(value.lastIndexOf('-') + 1);
      return region;
    }
  });
  return region;
}
/**
 * Show a specific popup. Sets a cookie and adds a visibility class.
 *
 * @param {Object} popupMessage
 * @param {number} cookieDayTotal
 * @param {string} popupShownCookieName
 * @param {string} popupVisibleClass
 * @param {string} validatedSessionClass
 */


function showPopup(popupMessage, cookieDayTotal, popupShownCookieName, popupVisibleClass, validatedSessionClass) {
  setCookie(popupShownCookieName, 'true', cookieDayTotal);
  var validatedItems = document.querySelectorAll('.' + validatedSessionClass);

  if (0 < validatedItems.length) {
    validatedItems.forEach(function (validatedMessage) {
      validatedMessage.classList.add(popupVisibleClass);
    });
  } else {
    popupMessage.classList.add(popupVisibleClass);
  }
}
/**
 * Show a specific popup. Sets a cookie and adds a visibility class.
 *
 * @param {Object} popupMessage
 * @param {string} popupVisibleClass
 * @param {Object} lastFocus
 * @param {string} closeTrigger
 */


function hidePopup(popupMessage, popupVisibleClass, lastFocus, closeTrigger) {
  lastFocus.focus();
  popupMessage.classList.remove(popupVisibleClass);
  var popupId = getPostId(popupMessage);

  if (0 !== popupId) {
    analyticsTrackingEvent('event', 'Popup', closeTrigger, popupId, undefined, 1);
  }
}
/**
 * Display and controls for popups
 *
 * @param {Object} popupMessage
 * @param {number} cookieDayTotal
 * @param {string} popupShownCookieName
 * @param {string} popupVisibleClass
 * @param {string} checkSessionClass
 * @param {string} validatedSessionClass
 */


function popupDisplay(popupMessage, cookieDayTotal, popupShownCookieName, popupVisibleClass, checkSessionClass, validatedSessionClass) {
  var lastFocus = document.activeElement; // eslint-disable-line
  // Check if we should be showing the popup

  if ('true' !== getCookie(popupShownCookieName) && (!popupMessage.classList.contains(checkSessionClass) || popupMessage.classList.contains(validatedSessionClass))) {
    // actually show the popup
    showPopup(popupMessage, cookieDayTotal, popupShownCookieName, popupVisibleClass, validatedSessionClass); // run messageAnalytics on the popup

    messageAnalytics(popupMessage); // 1. detect clicks inside the popup that should close it.

    popupMessage.addEventListener('click', function (event) {
      var isCloseButton = event.target.classList.contains('sm-close-btn');

      if (true === isCloseButton) {
        event.preventDefault();
        hidePopup(popupMessage, popupVisibleClass, lastFocus, 'Close Button');
      }
    }, true); // 2. detect clicks outside the popup.

    document.addEventListener('click', function (evt) {
      var targetElement = evt.target;

      do {
        if (targetElement === popupMessage) {
          return;
        } // Go up the DOM


        targetElement = targetElement.parentNode;
      } while (targetElement); // This is a click outside.


      hidePopup(popupMessage, popupVisibleClass, lastFocus, 'Click Outside to Close');
    }); // 3. detect escape key press

    document.onkeydown = function (evt) {
      evt = evt || window.event;
      var isEscape = false;

      if ('key' in evt) {
        isEscape = evt.key === 'Escape' || evt.key === 'Esc';
      } else {
        isEscape = evt.keyCode === 27;
      }

      if (isEscape) {
        hidePopup(popupMessage, popupVisibleClass, lastFocus, 'Escape Key');
      }
    };
  } // end of if statement for the conditional to show this popup.

}
/**
 * Set up google analytics events.
 *
 * @param {Object} message
 */


function messageAnalytics(message) {
  var messageRegion = getMessageRegion(message);
  var messageId = getPostId(message);
  var messageDisplay = window.getComputedStyle(message, null).display; // tell analytics if a message is being displayed

  if ('none' !== messageDisplay) {
    analyticsTrackingEvent('event', messageRegion, 'Show', messageId, undefined, 1); // click tracker for analytics events

    message.addEventListener('click', function (event) {
      // 1. is it a login link or close button?
      // the close event will have already been tracked by the hidePopup method.
      var isLoginClick = event.target.classList.contains('message-login');
      var isCloseButton = event.target.classList.contains('sm-close-btn');

      if (true === isLoginClick) {
        var url = $(this).attr('href');
        analyticsTrackingEvent('event', messageRegion, 'Login Link', url);
      } else if (false === isCloseButton) {
        // 2. other links
        analyticsTrackingEvent('event', messageRegion, 'Click', messageId);
      }
    }, true);
  }
}
/**
 * When the document is loaded, set up session tracking and popup display
 *
 */


document.addEventListener('DOMContentLoaded', function () {
  var popupSelector = 'wp-message-inserter-message-region-popup';
  var popupShownCookieName = 'sm-shown';
  var popupVisibleClass = 'wp-message-inserter-message-popup-visible';
  var checkSessionClass = 'check-session-message';
  var messageSelector = 'wp-message-inserter-message';
  var validatedSessionClass = 'validated';
  var checkSessionItems = document.querySelectorAll('.' + checkSessionClass);

  if (0 < checkSessionItems.length) {
    // get the current count of sessions and set the operators for comparison
    var currentCount = setCurrentCount();
    var operators = {
      gt: function gt(a, b) {
        return a >= b;
      },
      lt: function lt(a, b) {
        return a <= b;
      }
    }; // handle messages that are session-dependent

    checkSessionItems.forEach(function (currentSessionMessage) {
      var bannerSessionCount = parseInt(currentSessionMessage.dataset.sessionCountToCheck);
      var bannerSessionOperator = currentSessionMessage.dataset.sessionCountOperator;

      if (operators[bannerSessionOperator](currentCount, bannerSessionCount)) {
        if (currentSessionMessage.classList.contains(popupSelector)) {
          currentSessionMessage.classList.add(validatedSessionClass);
        } else if (!getCookie(popupShownCookieName)) {
          currentSessionMessage.classList.add(validatedSessionClass);
        }
      }
    });
  }

  var popupMessage = document.querySelector('.' + popupSelector);

  if (null !== popupMessage) {
    // get our value for days and hours to set cookie
    var closeTimeDays = parseInt(popupMessage.dataset.closeTimeDays) || 0;
    var closeTimeHours = (parseInt(popupMessage.dataset.closeTimeHours) || 0) / 24; // Our Total for when the cookie should expire and show the banner again

    var cookieDayTotal = closeTimeDays + closeTimeHours; // determines whether to display a popup

    popupDisplay(popupMessage, cookieDayTotal, popupShownCookieName, popupVisibleClass, checkSessionClass, validatedSessionClass);
  } // analytics events for any kind of message that is displayed


  var messageItems = document.querySelectorAll('.' + messageSelector + ':not( .' + popupSelector + ' )');

  if (0 < messageItems.length) {
    messageItems.forEach(function (currentMessage) {
      messageAnalytics(currentMessage);
    });
  }
});
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIjAxLW1lc3NhZ2VzLmpzIl0sIm5hbWVzIjpbInNldENvb2tpZSIsIm5hbWUiLCJ2YWx1ZSIsImRheXMiLCJkIiwiRGF0ZSIsInNldFRpbWUiLCJnZXRUaW1lIiwiZG9jdW1lbnQiLCJjb29raWUiLCJ0b0dNVFN0cmluZyIsImdldENvb2tpZSIsIm1hdGNoIiwiYW5hbHl0aWNzVHJhY2tpbmdFdmVudCIsInR5cGUiLCJjYXRlZ29yeSIsImFjdGlvbiIsImxhYmVsIiwibm9uSW50ZXJhY3Rpb24iLCJ3cCIsImNoYXJBdCIsInRvVXBwZXJDYXNlIiwic2xpY2UiLCJob29rcyIsImRvQWN0aW9uIiwic2V0Q3VycmVudENvdW50IiwiY3VycmVudENvdW50IiwidGltZXN0YW1wIiwiTWF0aCIsImZsb29yIiwiY29va2llRXhwaXJhdGlvbiIsInVybFBhcmFtcyIsIlVSTFNlYXJjaFBhcmFtcyIsIndpbmRvdyIsImxvY2F0aW9uIiwic2VhcmNoIiwiZ2V0IiwicGFyc2VJbnQiLCJnZXRQb3N0SWQiLCJtZXNzYWdlIiwicG9zdElkIiwiY2xhc3NMaXN0IiwiZm9yRWFjaCIsImluZGV4T2YiLCJzdWJzdHJpbmciLCJsYXN0SW5kZXhPZiIsImdldE1lc3NhZ2VSZWdpb24iLCJyZWdpb24iLCJzaG93UG9wdXAiLCJwb3B1cE1lc3NhZ2UiLCJjb29raWVEYXlUb3RhbCIsInBvcHVwU2hvd25Db29raWVOYW1lIiwicG9wdXBWaXNpYmxlQ2xhc3MiLCJ2YWxpZGF0ZWRTZXNzaW9uQ2xhc3MiLCJ2YWxpZGF0ZWRJdGVtcyIsInF1ZXJ5U2VsZWN0b3JBbGwiLCJsZW5ndGgiLCJ2YWxpZGF0ZWRNZXNzYWdlIiwiYWRkIiwiaGlkZVBvcHVwIiwibGFzdEZvY3VzIiwiY2xvc2VUcmlnZ2VyIiwiZm9jdXMiLCJyZW1vdmUiLCJwb3B1cElkIiwidW5kZWZpbmVkIiwicG9wdXBEaXNwbGF5IiwiY2hlY2tTZXNzaW9uQ2xhc3MiLCJhY3RpdmVFbGVtZW50IiwiY29udGFpbnMiLCJtZXNzYWdlQW5hbHl0aWNzIiwiYWRkRXZlbnRMaXN0ZW5lciIsImV2ZW50IiwiaXNDbG9zZUJ1dHRvbiIsInRhcmdldCIsInByZXZlbnREZWZhdWx0IiwiZXZ0IiwidGFyZ2V0RWxlbWVudCIsInBhcmVudE5vZGUiLCJvbmtleWRvd24iLCJpc0VzY2FwZSIsImtleSIsImtleUNvZGUiLCJtZXNzYWdlUmVnaW9uIiwibWVzc2FnZUlkIiwibWVzc2FnZURpc3BsYXkiLCJnZXRDb21wdXRlZFN0eWxlIiwiZGlzcGxheSIsImlzTG9naW5DbGljayIsInVybCIsIiQiLCJhdHRyIiwicG9wdXBTZWxlY3RvciIsIm1lc3NhZ2VTZWxlY3RvciIsImNoZWNrU2Vzc2lvbkl0ZW1zIiwib3BlcmF0b3JzIiwiZ3QiLCJhIiwiYiIsImx0IiwiY3VycmVudFNlc3Npb25NZXNzYWdlIiwiYmFubmVyU2Vzc2lvbkNvdW50IiwiZGF0YXNldCIsInNlc3Npb25Db3VudFRvQ2hlY2siLCJiYW5uZXJTZXNzaW9uT3BlcmF0b3IiLCJzZXNzaW9uQ291bnRPcGVyYXRvciIsInF1ZXJ5U2VsZWN0b3IiLCJjbG9zZVRpbWVEYXlzIiwiY2xvc2VUaW1lSG91cnMiLCJtZXNzYWdlSXRlbXMiLCJjdXJyZW50TWVzc2FnZSJdLCJtYXBwaW5ncyI6Ijs7QUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVNBLFNBQVQsQ0FBbUJDLElBQW5CLEVBQXlCQyxLQUF6QixFQUFnQ0MsSUFBaEMsRUFBc0M7RUFDckMsSUFBTUMsQ0FBQyxHQUFHLElBQUlDLElBQUosRUFBVjtFQUNBRCxDQUFDLENBQUNFLE9BQUYsQ0FBVUYsQ0FBQyxDQUFDRyxPQUFGLEtBQWMsV0FBV0osSUFBbkM7RUFDQUssUUFBUSxDQUFDQyxNQUFULEdBQWtCUixJQUFJLEdBQUcsR0FBUCxHQUFhQyxLQUFiLEdBQXFCLGtCQUFyQixHQUEwQ0UsQ0FBQyxDQUFDTSxXQUFGLEVBQTVEO0FBQ0E7QUFFRDtBQUNBO0FBQ0E7QUFDQTtBQUNBOzs7QUFDQSxTQUFT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QjtNQUM5Q3hDLGdCQUFnQixDQUFDd0MsY0FBRCxDQUFoQjtJQUNBLENBRkQ7RUFHQTtBQUNELENBeEVEIiwiZmlsZSI6IndwLW1lc3NhZ2UtaW5zZXJ0ZXItcGx1Z2luLWZyb250LWVuZC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogU2V0cyBjb29raWVzXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IG5hbWVcbiAqIEBwYXJhbSB7c3RyaW5nfSB2YWx1ZVxuICogQHBhcmFtIHtudW1iZXJ9IGRheXNcbiAqL1xuZnVuY3Rpb24gc2V0Q29va2llKG5hbWUsIHZhbHVlLCBkYXlzKSB7XG5cdGNvbnN0IGQgPSBuZXcgRGF0ZSgpO1xuXHRkLnNldFRpbWUoZC5nZXRUaW1lKCkgKyA4NjQwMDAwMCAqIGRheXMpO1xuXHRkb2N1bWVudC5jb29raWUgPSBuYW1lICsgJz0nICsgdmFsdWUgKyAnO3BhdGg9LztleHBpcmVzPScgKyBkLnRvR01UU3RyaW5nKCk7XG59XG5cbi8qKlxuICogUmVhZHMgY29va2llc1xuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBuYW1lXG4gKi9cbmZ1bmN0aW9uIGdldENvb2tpZShuYW1lKSB7XG5cdGNvbnN0IHZhbHVlID0gZG9jdW1lbnQuY29va2llLm1hdGNoKCcoXnw7KSA/JyArIG5hbWUgKyAnPShbXjtdKikoO3wkKScpO1xuXHRyZXR1cm4gdmFsdWUgPyB2YWx1ZVsyXSA6IG51bGw7XG59XG5cbi8qKlxuICogQWxsb3cgb3VyIHRoZW1lIG9yIG90aGVyIHBsdWdpbnMgdG8gY3JlYXRlIGFuYWx5dGljcyB0cmFja2luZyBldmVudHNcbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gIHR5cGVcbiAqIEBwYXJhbSB7c3RyaW5nfSAgY2F0ZWdvcnlcbiAqIEBwYXJhbSB7c3RyaW5nfSAgYWN0aW9uXG4gKiBAcGFyYW0ge3N0cmluZ30gIGxhYmVsXG4gKiBAcGFyYW0ge0FycmF5fSAgIHZhbHVlXG4gKiBAcGFyYW0ge2Jvb2xlYW59IG5vbkludGVyYWN0aW9uXG4gKi9cbmZ1bmN0aW9uIGFuYWx5dGljc1RyYWNraW5nRXZlbnQoXG5cdHR5cGUsXG5cdGNhdGVnb3J5LFxuXHRhY3Rpb24sXG5cdGxhYmVsLFxuXHR2YWx1ZSxcblx0bm9uSW50ZXJhY3Rpb25cbikge1xuXHRpZiAodHlwZW9mIHdwICE9PSAndW5kZWZpbmVkJykge1xuXHRcdGNhdGVnb3J5ID1cblx0XHRcdCdTaXRlIE1lc3NhZ2U6ICcgK1xuXHRcdFx0Y2F0ZWdvcnkuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgK1xuXHRcdFx0Y2F0ZWdvcnkuc2xpY2UoMSk7XG5cdFx0d3AuaG9va3MuZG9BY3Rpb24oXG5cdFx0XHQnd3BNZXNzYWdlSW5zZXJ0ZXJBbmFseXRpY3NFdmVudCcsXG5cdFx0XHR0eXBlLFxuXHRcdFx0Y2F0ZWdvcnksXG5cdFx0XHRhY3Rpb24sXG5cdFx0XHRsYWJlbCxcblx0XHRcdHZhbHVlLFxuXHRcdFx0bm9uSW50ZXJhY3Rpb25cblx0XHQpO1xuXHR9XG59XG5cbi8qKlxuICogRmF1eCBcIlNlc3Npb25cIiBjaGVja2luZy9zZXR0aW5nLlxuICpcbiAqIEByZXR1cm4ge251bWJlcn0gY3VycmVudENvdW50XG4gKi9cbmZ1bmN0aW9uIHNldEN1cnJlbnRDb3VudCgpIHtcblx0Ly8gVGltZXN0YW1wIHN0b3JlZCBvbiB0aGUgY29va2llXG5cdGxldCBjdXJyZW50Q291bnQgPSBnZXRDb29raWUoJ2NvdW50Jyk7XG5cdGNvbnN0IHRpbWVzdGFtcCA9IE1hdGguZmxvb3IobmV3IERhdGUoKS5nZXRUaW1lKCkgLyAxMDAwKTtcblx0Y29uc3QgY29va2llRXhwaXJhdGlvbiA9IDMwOyAvLyBleHBpcmUgdGhlIGNvb2tlIGluIDMwIGRheXNcblx0aWYgKCFnZXRDb29raWUoJ2NvdW50JykpIHtcblx0XHQvLyBGaXJzdCBWaXNpdCAtIHNldCBjb3VudCB0byAxXG5cdFx0c2V0Q29va2llKCdjb3VudCcsIDEsIGNvb2tpZUV4cGlyYXRpb24pO1xuXHRcdC8vIFNldCBhIHRpbWVjaGVjayBjb29raWUgZm9yIGFuIGhvdXIgZnJvbSBub3dcblx0XHRzZXRDb29raWUoJ3RpbWVjaGVjaycsIHRpbWVzdGFtcCArIDM2MDAsIGNvb2tpZUV4cGlyYXRpb24pO1xuXHR9IGVsc2UgaWYgKHRpbWVzdGFtcCA+IGdldENvb2tpZSgndGltZWNoZWNrJykpIHtcblx0XHQvLyBVcGRhdGUgVGltZWNoZWNrIHRvIG5ldyB2YWx1ZVxuXHRcdHNldENvb2tpZSgndGltZWNoZWNrJywgdGltZXN0YW1wICsgMzYwMCwgY29va2llRXhwaXJhdGlvbik7XG5cdFx0Ly8gQ291bnQgZXhpc3RzIGFscmVhZHkgYW5kIGl0IGhhcyBiZWVuIGFuIGhvdXIuIFVwZGF0ZSBjb3VudFxuXHRcdHNldENvb2tpZSgnY291bnQnLCArK2N1cnJlbnRDb3VudCwgY29va2llRXhwaXJhdGlvbik7XG5cdH1cblx0Y29uc3QgdXJsUGFyYW1zID0gbmV3IFVSTFNlYXJjaFBhcmFtcyh3aW5kb3cubG9jYXRpb24uc2VhcmNoKTtcblx0aWYgKHVybFBhcmFtcy5nZXQoJ2NvdW50JykgIT09IG51bGwpIHtcblx0XHRjdXJyZW50Q291bnQgPSBwYXJzZUludCh1cmxQYXJhbXMuZ2V0KCdjb3VudCcpKTtcblx0fVxuXHRyZXR1cm4gY3VycmVudENvdW50O1xufVxuXG4vKipcbiAqIEdldCB0aGUgV29yZFByZXNzIHBvc3QgSUQgZm9yIGEgZ2l2ZW4gcG9wdXAuXG4gKlxuICogQHBhcmFtIHtPYmplY3R9IG1lc3NhZ2VcbiAqIEByZXR1cm4ge251bWJlcn0gcG9zdElkXG4gKi9cbmZ1bmN0aW9uIGdldFBvc3RJZChtZXNzYWdlKSB7XG5cdGxldCBwb3N0SWQgPSAwO1xuXHRtZXNzYWdlLmNsYXNzTGlzdC5mb3JFYWNoKGZ1bmN0aW9uICh2YWx1ZSkge1xuXHRcdGlmICgwIDwgdmFsdWUuaW5kZXhPZignbWVzc2FnZS1pZCcpKSB7XG5cdFx0XHRwb3N0SWQgPSB2YWx1ZS5zdWJzdHJpbmcodmFsdWUubGFzdEluZGV4T2YoJy0nKSArIDEpO1xuXHRcdFx0cmV0dXJuIHBvc3RJZDtcblx0XHR9XG5cdH0pO1xuXHRyZXR1cm4gcG9zdElkO1xufVxuXG4vKipcbiAqIEdldCB0aGUgcmVnaW9uIGZvciBhIGdpdmVuIG1lc3NhZ2UuXG4gKlxuICogQHBhcmFtIHtPYmplY3R9IG1lc3NhZ2VcbiAqIEByZXR1cm4ge3N0cmluZ30gcmVnaW9uXG4gKi9cbmZ1bmN0aW9uIGdldE1lc3NhZ2VSZWdpb24obWVzc2FnZSkge1xuXHRsZXQgcmVnaW9uID0gJyc7XG5cdG1lc3NhZ2UuY2xhc3NMaXN0LmZvckVhY2goZnVuY3Rpb24gKHZhbHVlKSB7XG5cdFx0aWYgKDAgPCB2YWx1ZS5pbmRleE9mKCdtZXNzYWdlLXJlZ2lvbicpKSB7XG5cdFx0XHRyZWdpb24gPSB2YWx1ZS5zdWJzdHJpbmcodmFsdWUubGFzdEluZGV4T2YoJy0nKSArIDEpO1xuXHRcdFx0cmV0dXJuIHJlZ2lvbjtcblx0XHR9XG5cdH0pO1xuXHRyZXR1cm4gcmVnaW9uO1xufVxuXG4vKipcbiAqIFNob3cgYSBzcGVjaWZpYyBwb3B1cC4gU2V0cyBhIGNvb2tpZSBhbmQgYWRkcyBhIHZpc2liaWxpdHkgY2xhc3MuXG4gKlxuICogQHBhcmFtIHtPYmplY3R9IHBvcHVwTWVzc2FnZVxuICogQHBhcmFtIHtudW1iZXJ9IGNvb2tpZURheVRvdGFsXG4gKiBAcGFyYW0ge3N0cmluZ30gcG9wdXBTaG93bkNvb2tpZU5hbWVcbiAqIEBwYXJhbSB7c3RyaW5nfSBwb3B1cFZpc2libGVDbGFzc1xuICogQHBhcmFtIHtzdHJpbmd9IHZhbGlkYXRlZFNlc3Npb25DbGFzc1xuICovXG5mdW5jdGlvbiBzaG93UG9wdXAoXG5cdHBvcHVwTWVzc2FnZSxcblx0Y29va2llRGF5VG90YWwsXG5cdHBvcHVwU2hvd25Db29raWVOYW1lLFxuXHRwb3B1cFZpc2libGVDbGFzcyxcblx0dmFsaWRhdGVkU2Vzc2lvbkNsYXNzXG4pIHtcblx0c2V0Q29va2llKHBvcHVwU2hvd25Db29raWVOYW1lLCAndHJ1ZScsIGNvb2tpZURheVRvdGFsKTtcblx0Y29uc3QgdmFsaWRhdGVkSXRlbXMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKFxuXHRcdCcuJyArIHZhbGlkYXRlZFNlc3Npb25DbGFzc1xuXHQpO1xuXHRpZiAoMCA8IHZhbGlkYXRlZEl0ZW1zLmxlbmd0aCkge1xuXHRcdHZhbGlkYXRlZEl0ZW1zLmZvckVhY2goZnVuY3Rpb24gKHZhbGlkYXRlZE1lc3NhZ2UpIHtcblx0XHRcdHZhbGlkYXRlZE1lc3NhZ2UuY2xhc3NMaXN0LmFkZChwb3B1cFZpc2libGVDbGFzcyk7XG5cdFx0fSk7XG5cdH0gZWxzZSB7XG5cdFx0cG9wdXBNZXNzYWdlLmNsYXNzTGlzdC5hZGQocG9wdXBWaXNpYmxlQ2xhc3MpO1xuXHR9XG59XG5cbi8qKlxuICogU2hvdyBhIHNwZWNpZmljIHBvcHVwLiBTZXRzIGEgY29va2llIGFuZCBhZGRzIGEgdmlzaWJpbGl0eSBjbGFzcy5cbiAqXG4gKiBAcGFyYW0ge09iamVjdH0gcG9wdXBNZXNzYWdlXG4gKiBAcGFyYW0ge3N0cmluZ30gcG9wdXBWaXNpYmxlQ2xhc3NcbiAqIEBwYXJhbSB7T2JqZWN0fSBsYXN0Rm9jdXNcbiAqIEBwYXJhbSB7c3RyaW5nfSBjbG9zZVRyaWdnZXJcbiAqL1xuZnVuY3Rpb24gaGlkZVBvcHVwKHBvcHVwTWVzc2FnZSwgcG9wdXBWaXNpYmxlQ2xhc3MsIGxhc3RGb2N1cywgY2xvc2VUcmlnZ2VyKSB7XG5cdGxhc3RGb2N1cy5mb2N1cygpO1xuXHRwb3B1cE1lc3NhZ2UuY2xhc3NMaXN0LnJlbW92ZShwb3B1cFZpc2libGVDbGFzcyk7XG5cdGNvbnN0IHBvcHVwSWQgPSBnZXRQb3N0SWQocG9wdXBNZXNzYWdlKTtcblx0aWYgKDAgIT09IHBvcHVwSWQpIHtcblx0XHRhbmFseXRpY3NUcmFja2luZ0V2ZW50KFxuXHRcdFx0J2V2ZW50Jyxcblx0XHRcdCdQb3B1cCcsXG5cdFx0XHRjbG9zZVRyaWdnZXIsXG5cdFx0XHRwb3B1cElkLFxuXHRcdFx0dW5kZWZpbmVkLFxuXHRcdFx0MVxuXHRcdCk7XG5cdH1cbn1cblxuLyoqXG4gKiBEaXNwbGF5IGFuZCBjb250cm9scyBmb3IgcG9wdXBzXG4gKlxuICogQHBhcmFtIHtPYmplY3R9IHBvcHVwTWVzc2FnZVxuICogQHBhcmFtIHtudW1iZXJ9IGNvb2tpZURheVRvdGFsXG4gKiBAcGFyYW0ge3N0cmluZ30gcG9wdXBTaG93bkNvb2tpZU5hbWVcbiAqIEBwYXJhbSB7c3RyaW5nfSBwb3B1cFZpc2libGVDbGFzc1xuICogQHBhcmFtIHtzdHJpbmd9IGNoZWNrU2Vzc2lvbkNsYXNzXG4gKiBAcGFyYW0ge3N0cmluZ30gdmFsaWRhdGVkU2Vzc2lvbkNsYXNzXG4gKi9cbmZ1bmN0aW9uIHBvcHVwRGlzcGxheShcblx0cG9wdXBNZXNzYWdlLFxuXHRjb29raWVEYXlUb3RhbCxcblx0cG9wdXBTaG93bkNvb2tpZU5hbWUsXG5cdHBvcHVwVmlzaWJsZUNsYXNzLFxuXHRjaGVja1Nlc3Npb25DbGFzcyxcblx0dmFsaWRhdGVkU2Vzc2lvbkNsYXNzXG4pIHtcblx0Y29uc3QgbGFzdEZvY3VzID0gZG9jdW1lbnQuYWN0aXZlRWxlbWVudDsgLy8gZXNsaW50LWRpc2FibGUtbGluZVxuXHQvLyBDaGVjayBpZiB3ZSBzaG91bGQgYmUgc2hvd2luZyB0aGUgcG9wdXBcblx0aWYgKFxuXHRcdCd0cnVlJyAhPT0gZ2V0Q29va2llKHBvcHVwU2hvd25Db29raWVOYW1lKSAmJlxuXHRcdCghcG9wdXBNZXNzYWdlLmNsYXNzTGlzdC5jb250YWlucyhjaGVja1Nlc3Npb25DbGFzcykgfHxcblx0XHRcdHBvcHVwTWVzc2FnZS5jbGFzc0xpc3QuY29udGFpbnModmFsaWRhdGVkU2Vzc2lvbkNsYXNzKSlcblx0KSB7XG5cdFx0Ly8gYWN0dWFsbHkgc2hvdyB0aGUgcG9wdXBcblx0XHRzaG93UG9wdXAoXG5cdFx0XHRwb3B1cE1lc3NhZ2UsXG5cdFx0XHRjb29raWVEYXlUb3RhbCxcblx0XHRcdHBvcHVwU2hvd25Db29raWVOYW1lLFxuXHRcdFx0cG9wdXBWaXNpYmxlQ2xhc3MsXG5cdFx0XHR2YWxpZGF0ZWRTZXNzaW9uQ2xhc3Ncblx0XHQpO1xuXG5cdFx0Ly8gcnVuIG1lc3NhZ2VBbmFseXRpY3Mgb24gdGhlIHBvcHVwXG5cdFx0bWVzc2FnZUFuYWx5dGljcyhwb3B1cE1lc3NhZ2UpO1xuXG5cdFx0Ly8gMS4gZGV0ZWN0IGNsaWNrcyBpbnNpZGUgdGhlIHBvcHVwIHRoYXQgc2hvdWxkIGNsb3NlIGl0LlxuXHRcdHBvcHVwTWVzc2FnZS5hZGRFdmVudExpc3RlbmVyKFxuXHRcdFx0J2NsaWNrJyxcblx0XHRcdGZ1bmN0aW9uIChldmVudCkge1xuXHRcdFx0XHRjb25zdCBpc0Nsb3NlQnV0dG9uID1cblx0XHRcdFx0XHRldmVudC50YXJnZXQuY2xhc3NMaXN0LmNvbnRhaW5zKCdzbS1jbG9zZS1idG4nKTtcblx0XHRcdFx0aWYgKHRydWUgPT09IGlzQ2xvc2VCdXR0b24pIHtcblx0XHRcdFx0XHRldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuXHRcdFx0XHRcdGhpZGVQb3B1cChcblx0XHRcdFx0XHRcdHBvcHVwTWVzc2FnZSxcblx0XHRcdFx0XHRcdHBvcHVwVmlzaWJsZUNsYXNzLFxuXHRcdFx0XHRcdFx0bGFzdEZvY3VzLFxuXHRcdFx0XHRcdFx0J0Nsb3NlIEJ1dHRvbidcblx0XHRcdFx0XHQpO1xuXHRcdFx0XHR9XG5cdFx0XHR9LFxuXHRcdFx0dHJ1ZVxuXHRcdCk7XG5cblx0XHQvLyAyLiBkZXRlY3QgY2xpY2tzIG91dHNpZGUgdGhlIHBvcHVwLlxuXHRcdGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGV2dCkgPT4ge1xuXHRcdFx0bGV0IHRhcmdldEVsZW1lbnQgPSBldnQudGFyZ2V0O1xuXHRcdFx0ZG8ge1xuXHRcdFx0XHRpZiAodGFyZ2V0RWxlbWVudCA9PT0gcG9wdXBNZXNzYWdlKSB7XG5cdFx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0XHR9XG5cdFx0XHRcdC8vIEdvIHVwIHRoZSBET01cblx0XHRcdFx0dGFyZ2V0RWxlbWVudCA9IHRhcmdldEVsZW1lbnQucGFyZW50Tm9kZTtcblx0XHRcdH0gd2hpbGUgKHRhcmdldEVsZW1lbnQpO1xuXHRcdFx0Ly8gVGhpcyBpcyBhIGNsaWNrIG91dHNpZGUuXG5cdFx0XHRoaWRlUG9wdXAoXG5cdFx0XHRcdHBvcHVwTWVzc2FnZSxcblx0XHRcdFx0cG9wdXBWaXNpYmxlQ2xhc3MsXG5cdFx0XHRcdGxhc3RGb2N1cyxcblx0XHRcdFx0J0NsaWNrIE91dHNpZGUgdG8gQ2xvc2UnXG5cdFx0XHQpO1xuXHRcdH0pO1xuXG5cdFx0Ly8gMy4gZGV0ZWN0IGVzY2FwZSBrZXkgcHJlc3Ncblx0XHRkb2N1bWVudC5vbmtleWRvd24gPSBmdW5jdGlvbiAoZXZ0KSB7XG5cdFx0XHRldnQgPSBldnQgfHwgd2luZG93LmV2ZW50O1xuXHRcdFx0bGV0IGlzRXNjYXBlID0gZmFsc2U7XG5cdFx0XHRpZiAoJ2tleScgaW4gZXZ0KSB7XG5cdFx0XHRcdGlzRXNjYXBlID0gZXZ0LmtleSA9PT0gJ0VzY2FwZScgfHwgZXZ0LmtleSA9PT0gJ0VzYyc7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRpc0VzY2FwZSA9IGV2dC5rZXlDb2RlID09PSAyNztcblx0XHRcdH1cblx0XHRcdGlmIChpc0VzY2FwZSkge1xuXHRcdFx0XHRoaWRlUG9wdXAoXG5cdFx0XHRcdFx0cG9wdXBNZXNzYWdlLFxuXHRcdFx0XHRcdHBvcHVwVmlzaWJsZUNsYXNzLFxuXHRcdFx0XHRcdGxhc3RGb2N1cyxcblx0XHRcdFx0XHQnRXNjYXBlIEtleSdcblx0XHRcdFx0KTtcblx0XHRcdH1cblx0XHR9O1xuXHR9IC8vIGVuZCBvZiBpZiBzdGF0ZW1lbnQgZm9yIHRoZSBjb25kaXRpb25hbCB0byBzaG93IHRoaXMgcG9wdXAuXG59XG5cbi8qKlxuICogU2V0IHVwIGdvb2dsZSBhbmFseXRpY3MgZXZlbnRzLlxuICpcbiAqIEBwYXJhbSB7T2JqZWN0fSBtZXNzYWdlXG4gKi9cbmZ1bmN0aW9uIG1lc3NhZ2VBbmFseXRpY3MobWVzc2FnZSkge1xuXHRjb25zdCBtZXNzYWdlUmVnaW9uID0gZ2V0TWVzc2FnZVJlZ2lvbihtZXNzYWdlKTtcblx0Y29uc3QgbWVzc2FnZUlkID0gZ2V0UG9zdElkKG1lc3NhZ2UpO1xuXHRjb25zdCBtZXNzYWdlRGlzcGxheSA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKG1lc3NhZ2UsIG51bGwpLmRpc3BsYXk7XG5cdC8vIHRlbGwgYW5hbHl0aWNzIGlmIGEgbWVzc2FnZSBpcyBiZWluZyBkaXNwbGF5ZWRcblx0aWYgKCdub25lJyAhPT0gbWVzc2FnZURpc3BsYXkpIHtcblx0XHRhbmFseXRpY3NUcmFja2luZ0V2ZW50KFxuXHRcdFx0J2V2ZW50Jyxcblx0XHRcdG1lc3NhZ2VSZWdpb24sXG5cdFx0XHQnU2hvdycsXG5cdFx0XHRtZXNzYWdlSWQsXG5cdFx0XHR1bmRlZmluZWQsXG5cdFx0XHQxXG5cdFx0KTtcblx0XHQvLyBjbGljayB0cmFja2VyIGZvciBhbmFseXRpY3MgZXZlbnRzXG5cdFx0bWVzc2FnZS5hZGRFdmVudExpc3RlbmVyKFxuXHRcdFx0J2NsaWNrJyxcblx0XHRcdGZ1bmN0aW9uIChldmVudCkge1xuXHRcdFx0XHQvLyAxLiBpcyBpdCBhIGxvZ2luIGxpbmsgb3IgY2xvc2UgYnV0dG9uP1xuXHRcdFx0XHQvLyB0aGUgY2xvc2UgZXZlbnQgd2lsbCBoYXZlIGFscmVhZHkgYmVlbiB0cmFja2VkIGJ5IHRoZSBoaWRlUG9wdXAgbWV0aG9kLlxuXHRcdFx0XHRjb25zdCBpc0xvZ2luQ2xpY2sgPVxuXHRcdFx0XHRcdGV2ZW50LnRhcmdldC5jbGFzc0xpc3QuY29udGFpbnMoJ21lc3NhZ2UtbG9naW4nKTtcblx0XHRcdFx0Y29uc3QgaXNDbG9zZUJ1dHRvbiA9XG5cdFx0XHRcdFx0ZXZlbnQudGFyZ2V0LmNsYXNzTGlzdC5jb250YWlucygnc20tY2xvc2UtYnRuJyk7XG5cdFx0XHRcdGlmICh0cnVlID09PSBpc0xvZ2luQ2xpY2spIHtcblx0XHRcdFx0XHRjb25zdCB1cmwgPSAkKHRoaXMpLmF0dHIoJ2hyZWYnKTtcblx0XHRcdFx0XHRhbmFseXRpY3NUcmFja2luZ0V2ZW50KFxuXHRcdFx0XHRcdFx0J2V2ZW50Jyxcblx0XHRcdFx0XHRcdG1lc3NhZ2VSZWdpb24sXG5cdFx0XHRcdFx0XHQnTG9naW4gTGluaycsXG5cdFx0XHRcdFx0XHR1cmxcblx0XHRcdFx0XHQpO1xuXHRcdFx0XHR9IGVsc2UgaWYgKGZhbHNlID09PSBpc0Nsb3NlQnV0dG9uKSB7XG5cdFx0XHRcdFx0Ly8gMi4gb3RoZXIgbGlua3Ncblx0XHRcdFx0XHRhbmFseXRpY3NUcmFja2luZ0V2ZW50KFxuXHRcdFx0XHRcdFx0J2V2ZW50Jyxcblx0XHRcdFx0XHRcdG1lc3NhZ2VSZWdpb24sXG5cdFx0XHRcdFx0XHQnQ2xpY2snLFxuXHRcdFx0XHRcdFx0bWVzc2FnZUlkXG5cdFx0XHRcdFx0KTtcblx0XHRcdFx0fVxuXHRcdFx0fSxcblx0XHRcdHRydWVcblx0XHQpO1xuXHR9XG59XG5cbi8qKlxuICogV2hlbiB0aGUgZG9jdW1lbnQgaXMgbG9hZGVkLCBzZXQgdXAgc2Vzc2lvbiB0cmFja2luZyBhbmQgcG9wdXAgZGlzcGxheVxuICpcbiAqL1xuZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIGZ1bmN0aW9uICgpIHtcblx0Y29uc3QgcG9wdXBTZWxlY3RvciA9ICd3cC1tZXNzYWdlLWluc2VydGVyLW1lc3NhZ2UtcmVnaW9uLXBvcHVwJztcblx0Y29uc3QgcG9wdXBTaG93bkNvb2tpZU5hbWUgPSAnc20tc2hvd24nO1xuXHRjb25zdCBwb3B1cFZpc2libGVDbGFzcyA9ICd3cC1tZXNzYWdlLWluc2VydGVyLW1lc3NhZ2UtcG9wdXAtdmlzaWJsZSc7XG5cdGNvbnN0IGNoZWNrU2Vzc2lvbkNsYXNzID0gJ2NoZWNrLXNlc3Npb24tbWVzc2FnZSc7XG5cdGNvbnN0IG1lc3NhZ2VTZWxlY3RvciA9ICd3cC1tZXNzYWdlLWluc2VydGVyLW1lc3NhZ2UnO1xuXHRjb25zdCB2YWxpZGF0ZWRTZXNzaW9uQ2xhc3MgPSAndmFsaWRhdGVkJztcblx0Y29uc3QgY2hlY2tTZXNzaW9uSXRlbXMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKFxuXHRcdCcuJyArIGNoZWNrU2Vzc2lvbkNsYXNzXG5cdCk7XG5cdGlmICgwIDwgY2hlY2tTZXNzaW9uSXRlbXMubGVuZ3RoKSB7XG5cdFx0Ly8gZ2V0IHRoZSBjdXJyZW50IGNvdW50IG9mIHNlc3Npb25zIGFuZCBzZXQgdGhlIG9wZXJhdG9ycyBmb3IgY29tcGFyaXNvblxuXHRcdGNvbnN0IGN1cnJlbnRDb3VudCA9IHNldEN1cnJlbnRDb3VudCgpO1xuXHRcdGNvbnN0IG9wZXJhdG9ycyA9IHtcblx0XHRcdGd0KGEsIGIpIHtcblx0XHRcdFx0cmV0dXJuIGEgPj0gYjtcblx0XHRcdH0sXG5cdFx0XHRsdChhLCBiKSB7XG5cdFx0XHRcdHJldHVybiBhIDw9IGI7XG5cdFx0XHR9LFxuXHRcdH07XG5cblx0XHQvLyBoYW5kbGUgbWVzc2FnZXMgdGhhdCBhcmUgc2Vzc2lvbi1kZXBlbmRlbnRcblx0XHRjaGVja1Nlc3Npb25JdGVtcy5mb3JFYWNoKGZ1bmN0aW9uIChjdXJyZW50U2Vzc2lvbk1lc3NhZ2UpIHtcblx0XHRcdGNvbnN0IGJhbm5lclNlc3Npb25Db3VudCA9IHBhcnNlSW50KFxuXHRcdFx0XHRjdXJyZW50U2Vzc2lvbk1lc3NhZ2UuZGF0YXNldC5zZXNzaW9uQ291bnRUb0NoZWNrXG5cdFx0XHQpO1xuXHRcdFx0Y29uc3QgYmFubmVyU2Vzc2lvbk9wZXJhdG9yID1cblx0XHRcdFx0Y3VycmVudFNlc3Npb25NZXNzYWdlLmRhdGFzZXQuc2Vzc2lvbkNvdW50T3BlcmF0b3I7XG5cdFx0XHRpZiAoXG5cdFx0XHRcdG9wZXJhdG9yc1tiYW5uZXJTZXNzaW9uT3BlcmF0b3JdKFxuXHRcdFx0XHRcdGN1cnJlbnRDb3VudCxcblx0XHRcdFx0XHRiYW5uZXJTZXNzaW9uQ291bnRcblx0XHRcdFx0KVxuXHRcdFx0KSB7XG5cdFx0XHRcdGlmIChjdXJyZW50U2Vzc2lvbk1lc3NhZ2UuY2xhc3NMaXN0LmNvbnRhaW5zKHBvcHVwU2VsZWN0b3IpKSB7XG5cdFx0XHRcdFx0Y3VycmVudFNlc3Npb25NZXNzYWdlLmNsYXNzTGlzdC5hZGQodmFsaWRhdGVkU2Vzc2lvbkNsYXNzKTtcblx0XHRcdFx0fSBlbHNlIGlmICghZ2V0Q29va2llKHBvcHVwU2hvd25Db29raWVOYW1lKSkge1xuXHRcdFx0XHRcdGN1cnJlbnRTZXNzaW9uTWVzc2FnZS5jbGFzc0xpc3QuYWRkKHZhbGlkYXRlZFNlc3Npb25DbGFzcyk7XG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHR9KTtcblx0fVxuXG5cdGNvbnN0IHBvcHVwTWVzc2FnZSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJy4nICsgcG9wdXBTZWxlY3Rvcik7XG5cdGlmIChudWxsICE9PSBwb3B1cE1lc3NhZ2UpIHtcblx0XHQvLyBnZXQgb3VyIHZhbHVlIGZvciBkYXlzIGFuZCBob3VycyB0byBzZXQgY29va2llXG5cdFx0Y29uc3QgY2xvc2VUaW1lRGF5cyA9IHBhcnNlSW50KHBvcHVwTWVzc2FnZS5kYXRhc2V0LmNsb3NlVGltZURheXMpIHx8IDA7XG5cdFx0Y29uc3QgY2xvc2VUaW1lSG91cnMgPVxuXHRcdFx0KHBhcnNlSW50KHBvcHVwTWVzc2FnZS5kYXRhc2V0LmNsb3NlVGltZUhvdXJzKSB8fCAwKSAvIDI0O1xuXHRcdC8vIE91ciBUb3RhbCBmb3Igd2hlbiB0aGUgY29va2llIHNob3VsZCBleHBpcmUgYW5kIHNob3cgdGhlIGJhbm5lciBhZ2FpblxuXHRcdGNvbnN0IGNvb2tpZURheVRvdGFsID0gY2xvc2VUaW1lRGF5cyArIGNsb3NlVGltZUhvdXJzO1xuXHRcdC8vIGRldGVybWluZXMgd2hldGhlciB0byBkaXNwbGF5IGEgcG9wdXBcblx0XHRwb3B1cERpc3BsYXkoXG5cdFx0XHRwb3B1cE1lc3NhZ2UsXG5cdFx0XHRjb29raWVEYXlUb3RhbCxcblx0XHRcdHBvcHVwU2hvd25Db29raWVOYW1lLFxuXHRcdFx0cG9wdXBWaXNpYmxlQ2xhc3MsXG5cdFx0XHRjaGVja1Nlc3Npb25DbGFzcyxcblx0XHRcdHZhbGlkYXRlZFNlc3Npb25DbGFzc1xuXHRcdCk7XG5cdH1cblxuXHQvLyBhbmFseXRpY3MgZXZlbnRzIGZvciBhbnkga2luZCBvZiBtZXNzYWdlIHRoYXQgaXMgZGlzcGxheWVkXG5cdGNvbnN0IG1lc3NhZ2VJdGVtcyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoXG5cdFx0Jy4nICsgbWVzc2FnZVNlbGVjdG9yICsgJzpub3QoIC4nICsgcG9wdXBTZWxlY3RvciArICcgKSdcblx0KTtcblx0aWYgKDAgPCBtZXNzYWdlSXRlbXMubGVuZ3RoKSB7XG5cdFx0bWVzc2FnZUl0ZW1zLmZvckVhY2goZnVuY3Rpb24gKGN1cnJlbnRNZXNzYWdlKSB7XG5cdFx0XHRtZXNzYWdlQW5hbHl0aWNzKGN1cnJlbnRNZXNzYWdlKTtcblx0XHR9KTtcblx0fVxufSk7XG4iXX0=
